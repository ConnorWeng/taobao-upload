<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>51淘上传</title>
    <script type="text/javascript"
            src="http://libs.baidu.com/jquery/1.7.2/jquery.min.js"></script>
    <import type="js" file="js.CLEditor1_4_4.cleditor" basepath="./Public"/>
    <import type="css" file="js.CLEditor1_4_4.cleditor" basepath="./Public"/>
    <import type="js" file="js.common" basepath="./Public"/>
    <import type="js" file="js.city" basepath="./Public"/>
    <style type="text/css">
      body {
        margin: 0;
        font-family: tahoma, arial, 宋体, sans-serif;
        font-size: 12px;
        font-style: normal;
        font-variant: normal;
        font-weight: normal;
        line-height: 30px;
      }
      h4 {
        margin: 0;
        padding: 0;
      }
      ul {
        list-style-image: none;
        list-style-position: outside;
        list-style-type: none;
        margin: 0px;
        padding: 0px;
      }
      li {
        margin: 0px auto 4px 0px;
        padding: 0px;
        line-height: 20px;
      }
      .container {
        width: 950px;
        margin: 0 auto;
      }
      .header {
        height: 30px;
        background: rgb(248, 248, 248);
      }
      .header span {
        margin-left: 5px;
      }
      .publish-btn {
        background: #1C86EE;
        font-size: 16px;
        color: white;
      }
      .main-header {
        height: 28px;
        background: rgb(225, 238, 254);
        padding-left: 15px;
      }
      .main-body {
        border: 1px solid rgb(193, 219, 255);
        float: left;
      }
      .main-left {
        width: 198px;
        padding-left: 15px;
      }
      .main-right {
        width: 718px;
        height: 100px;
        padding-left: 15px;
        display: table;
      }
      .main-right h3 {
        clear: both;
        margin: 15px 0px 5px 0px;
      }
      .category {
        float: left;
        width: 80px;
        margin-right: 10px;
        text-align: right;
        margin-top: 3px;
      }
      .content {
        min-height: 30px;
        width: 613px;
        float: left;
        background: rgb(248, 248, 248);
        margin-top: 5px;
      }
      .input-content {
        width: 613px;
        float: left;
        margin-top: 5px;
      }
      .props-ul div {
        width: 100px;
        float: left;
        margin-right: 10px;
        text-align: right;
      }
      .tips {
        background: rgb(255, 255, 229);
        border: 1px solid rgb(255, 204, 127);
        margin-left: 10px;
      }
      .sku-item {
        float: left;
        width: 150px;
      }
      .sku-item .editbox {
        width: 50px;
      }
      .color-lump {
        display: inline-block;
        width: 14px;
        height: 14px;
      }
      .sku-table {
        width: 100%;
        background: white;
        clear:both;
      }
      .sku-table {
        border: 1px solid gray;
      }
      .J_MapRow input {
        width: 80px;
      }
      .item-images li {
        float: left;
        margin-right: 10px;
      }
      .editbox {
        display: none;
      }
      .loading {
        display: none;
        margin-left:5px;
      }
    </style>
  </head>
  <body TOPMARGIN=0 LEFTMARGIN=0 MARGINWIDTH=0 MARGINHEIGHT=0>
    <div class="ad" style="margin: 0 auto; width: 1198px;">
      <img src="Public/Image/4555.jpg" height="120"></img>
    </div>
    <form id="mainform" action="{:U('Taobao/Upload/uploadItem')}" method="POST">
      <input type="hidden" name="itemImages" id="itemImages" value=""/>
      <input type="hidden" name="taobaoItemId" value="{$taobaoItemId}"/>
      <input type="hidden" name="cid" id="cid" value="{$cid}"/>
      <input type="hidden" name="propImgs" value="{$propImgs}"/>
      <input type="hidden" name="salePropsObject" value="{$salePropsObject}"/>
      <input type="hidden" name="J_SKUTableData" id="J_SKUTableData" value=""/>
      <input type="hidden" name="_fma_pu__0_d" id="desc-hidden" value=""/>
      <input type="hidden" name="_fma_pu__0_m" id="price-hidden" value=""/>
      <input type="hidden" name="_fma_pu__0_ti" id="title-hidden" value=""/>
      <input type="hidden" name="_fma_pu__0_po_place" id="location-state-hidden" value=""/>
      <input type="hidden" name="_fma_pu__0_po_city" id="location-city-hidden" value=""/>
      <input type="hidden" name="_fma_pu__0_o" id="outer-id-hidden" value=""/>
      <div class="container">
        <div class="header">
          <span>主店铺: {$nick}</span><span><a href="{:U('Taobao/Index/signOut')}&taobaoItemId={$taobaoItemId}">退出所有店铺</a></span>
          <foreach name="otherStoreSessions" item="store">
            | 副店铺{$key + 1}: {$store.nick}
            <a href="{:U('Taobao/Index/deleteStoreSession')}&nick={$store.nick}">退出</a>
          </foreach>
          <if condition="$isSubscribe">
            <span><a id="add-store" href="#" style="color:red">+店铺</a></span>
          </if>
          <span>
            <if condition="$isUploadedBefore">
              <i style="color:red">当前商品您已发布过！</i>
              <else/>
              <i>当前商品您没有发布过,可以放心搬家</i>
            </if>
          </span>
        </div>

        <div class="header-btn">
          <center>
              <button class="publish-btn" style="margin-top: 15px">不编辑了，立刻发布</button><img class="loading" src="Public/Image/loading.gif"></img>
              <div>
                  <ul class="imgs-need-move">
                  </ul>
              </div>
          </center>
        </div>


        <div class="main">
          <div class="main-header">
            <h3>填写宝贝基本信息</h3>
          </div>

          <div class="main-left main-body">
            <h4>设置利润和价格:</h4>
            <ul>
              <li>默认价格＝</li>
              <li>批发价 x <input id="percent" type="text" style="width:30px" value="{$percent}"/>% + <input id="profit" type="text" style="width:30px" value="{$profit}">元</li>
            </ul>
            <h4>设置邮费:</h4>
            <ul>
              <li><label><input id="sellerFreight" type="radio" name="freight" {$sellerFreight}/>卖家承担运费</label></li>
              <li><label><input id="buyerFreight" type="radio" name="freight" {$buyerFreight}/>买家承担运费</label>
              <ul style="margin-left: 20px">
                <li><label><input id="useModuFreight" type="radio" name="moduFreight" {$useModuFreight}/>使用运费模版</label>
                <select id="templateId" name="templateId">{$deliveryTemplateHtml}</select>
                </li>
                <li><label><input type="radio" name="moduFreight" {$postFreight}/>运费</label>
                <ul style="margin-left:20px;">
                  <li>平邮:<input style="width: 60px;" id="postFee" name="postFee" type="text" value="{$postFee}">元</li>
                  <li>快递:<input style="width: 60px;" id="expressFee" name="expressFee" type="text" value="{$expressFee}">元</li>
                  <li>EMS:<input style="width: 60px;" id="emsFee" name="emsFee" type="text" value="{$emsFee}">元</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
        <input type="button" class="saveAndEffect" value="保存并生效" style="width:175px">
          <div style="height:15px"></div>
        </div>

        <div class="main-right main-body">
          <h3>1.宝贝基本信息</h3>
          <ul>
            <li>
              <label class="category">宝贝属性:</label>
              <div class="content">
                <ul class="props-ul">
                  <li><div><label>货号:</label></div><input type="text" value="{$huoHao}"/></li>
                  {$propsHtml}
                </ul>
              </div>
              <label class="category">宝贝标题:</label>
              <div class="input-content">
                <input id="title" name="title" type="text" style="width: 400px" value="{$taobaoItemTitle}"/>
                <span class="title-countdown"></span>
              </div>
              <label class="category">一口价:</label>
              <div class="input-content">
                <input id="price" type="text" value="{$price}"/><span style="color:red">批发价:{$rawPrice}元</span>
              </div>
              <label class="category">宝贝规格:</label>
              <div class="content">
                <label style="display:block;">主要颜色:</label>
                <ul class="sku-list color">
                  {$colorPropHtml}
                </ul>
                <label style="display:block; clear:both;">尺码:</label>
                <ul class="sku-list size">
                  {$sizePropHtml}
                </ul>
                <table class="sku-table" cellspacing="0" style="visibility: visible;">
                  <thead>
                    <tr>
                      <th class="J_Map_1627207"><span>主要颜色</span></th>
                      <th class="J_Map_20509"><span>尺码</span></th>
                      <th class="J_Map_0"><span class="required">价格</span></th>
                      <th class="J_Map_0"><span class="required">数量</span></th>
                      <th class="J_Map_0"><span class="">商家编码</span></th>
                      <th class="J_Map_0"><span class="">商品条形码</span></th>
                    </tr>
                  </thead>
                  <tbody id="sku-tbody">
                  </tbody>
                </table>
              </div>
              <label class="category">宝贝数量:</label>
              <div class="input-content">
                <input id="num" name="num" type="text" value="999"/>
              </div>
              <label class="category">商家编码:</label>
              <div class="input-content">
                <input id="outer-id" type="text" value="{$outerId}"/>
              </div>
              <label class="category">宝贝图片:</label>
              <div class="content">
                <lable><span style="color:orange">注：超过400件宝贝主图不改，将会被随机投诉盗图</span> <span style="color:blue">点击主图可以进行替换</span></lable>
                <ul class="item-images">
                  <li>
                    <img style="width:90px;height:90px;" src="{$picUrl}"/>
                    <input class="picUrl" type="hidden" name="picUrl1" value="{$picUrl}"/>
                  </li>
                  <li>
                    <img style="width:90px;height:90px;" src="{$image0}"/>
                    <input class="picUrl" type="hidden" name="picUrl2" value="{$image0}"/>
                  </li>
                  <li>
                    <img style="width:90px;height:90px;" src="{$image1}"/>
                    <input class="picUrl" type="hidden" name="picUrl3" value="{$image1}"/>
                  </li>
                  <li>
                    <img style="width:90px;height:90px;" src="{$image2}"/>
                    <input class="picUrl" type="hidden" name="picUrl4" value="{$image2}"/>
                  </li>
                  <li>
                    <img style="width:90px;height:90px;" src="{$image3}"/>
                    <input class="picUrl" type="hidden" name="picUrl5" value="{$image3}"/>
                  </li>
                </ul>
              </div>
              <label class="category">宝贝描述:</label>
              <div class="content">
                <textarea id="desc" style="width: 100%;">{$desc}</textarea>
              </div>
              <label class="category">店铺类目:</label>
              <div class="input-content">
                <select name="sellerCats">{$sellerCatsHtml}</select>
              </div>
            </li>
          </ul>

          <h3>2.宝贝物流信息</h3>
          <ul>
            <li>
              <label class="category">所在地:</label>
              <div class="input-content">
                <select id="location-state">
                  <option value="">----请选择省份----</option>
                  <option value=安徽>安徽</option>
                  <option value=北京>北京</option>
                  <option value=重庆>重庆</option>
                  <option value=福建>福建</option>
                  <option value=甘肃>甘肃</option>
                  <option selected value=广东>广东</option>
                  <option value=广西>广西</option>
                  <option value=贵州>贵州</option>
                  <option value=海南>海南</option>
                  <option value=河北>河北</option>
                  <option value=黑龙江>黑龙江</option>
                  <option value=河南>河南</option>
                  <option value=湖北>湖北</option>
                  <option value=湖南>湖南</option>
                  <option value=江苏>江苏</option>
                  <option value=江西>江西</option>
                  <option value=吉林>吉林</option>
                  <option value=辽宁>辽宁</option>
                  <option value=内蒙古>内蒙古</option>
                  <option value=宁夏>宁夏</option>
                  <option value=青海>青海</option>
                  <option value=山东>山东</option>
                  <option value=上海>上海</option>
                  <option value=山西>山西</option>
                  <option value=陕西>陕西</option>
                  <option value=四川>四川</option>
                  <option value=天津>天津</option>
                  <option value=新疆>新疆</option>
                  <option value=西藏>西藏</option>
                  <option value=云南>云南</option>
                  <option value=浙江>浙江</option>
                  <option value=香港>香港</option>
                  <option value=澳门>澳门</option>
                  <option value=台湾>台湾</option>
                  <option value=海外>海外</option>
                </select>
              </div>
              <label class="category">城市:</label>
              <div class="input-content">
                <select id="location-city">
                  <option value="">----请选择城市----</option>
                  <option value="广州" selected>广州</option>
                </select>
              </div>
              <label class="category">运费:</label>
              <div class="input-content">
                <ul>
                  <li><label><input id="seller_freight" value="seller" type="radio" name="postages" {$sellerFreight}/>卖家承担运费</label></li>
                  <li><label><input id="buyer_freight" value="buyer" type="radio" name="postages" {$buyerFreight}/>买家承担运费</label>
                  <ul style="margin-left: 20px">
                    <li><label><input id="use_modu_freight" type="radio" name="post" {$useModuFreight}/>使用运费模版</label>
                    <select id="template_id" name="template_id">{$deliveryTemplateHtml}</select>
                    </li>
                    <li><label><input type="radio" name="post" {$postFreight}/>运费</label>
                    <ul style="margin-left:20px;">
                      <li>平邮:<input style="width: 60px;" id="post_fee" name="post_fee" type="text" value="{$postFee}">元</li>
                      <li>快递:<input style="width: 60px;" id="express_fee" name="express_fee" type="text" value="{$expressFee}">元</li>
                      <li>EMS:<input style="width: 60px;" id="ems_fee" name="ems_fee" type="text" value="{$emsFee}">元</li>
                    </ul>
                  </li>
                </ul>
              </div>
            </li>
          </ul>

          <h3>3.其他信息</h3>
          <ul>
            <li>
              <label class="category">有效期:</label>
              <div class="input-content">
                <label><input type="radio" checked/>7天</label>
                <span class="tips">即日起全网一口价宝贝的有效期统一为7天</span>
              </div>
              <label class="category">开始时间:</label>
              <div class="input-content">
                <ul>
                  <li><input type="radio" class="radio" name="_now" value="0" checked="checked"/><label for="_now0">立刻</label></li>
                  <li>
                    <input type="radio" class="radio"  name="_now" value="1"/>
                    <label for="_now1">设定</label>
                    <select id="__date" name="__date"></select>
                    <select id="__hour" name="__hour">
                      <option value="00">0</option>
                      <option value="01">1</option>
                      <option value="02">2</option>
                      <option value="03">3</option>
                      <option value="04">4</option>
                      <option value="05">5</option>
                      <option value="06">6</option>
                      <option value="07">7</option>
                      <option value="08">8</option>
                      <option value="09">9</option>
                      <option value="10">10</option>
                      <option value="11">11</option>
                      <option value="12">12</option>
                      <option value="13">13</option>
                      <option value="14">14</option>
                      <option value="15">15</option>
                      <option value="16">16</option>
                      <option value="17">17</option>
                      <option value="18">18</option>
                      <option value="19">19</option>
                      <option value="20">20</option>
                      <option value="21">21</option>
                      <option value="22">22</option>
                      <option value="23">23</option>
                    </select>
                    时
                    <select id="__minute" name="__minute">
                      <option value="00">0</option>
                      <option value="05">5</option>
                      <option value="10">10</option>
                      <option value="15">15</option>
                      <option value="20">20</option>
                      <option value="25">25</option>
                      <option value="30">30</option>
                      <option value="35">35</option>
                      <option value="40">40</option>
                      <option value="45">45</option>
                      <option value="50">50</option>
                      <option value="55">55</option>
                    </select>
                    分
                    <i class="J_PopTip poptip-help">您可以设定宝贝的正式开始销售时间</i>
                  </li>
                  <li><input type="radio" class="radio"  name="_now" value="2" id="inStock"/><label for="inStock">放入仓库</label></li>
                </ul>
              </div>
              <label class="category">图片搬家:</label>
              <div class="input-content">
                <label><input name="movePic" type="checkbox" {$movePic}/>是</label>
                <span class="tips">上传成功后,图片会在2-3分钟内更新完成,您无需等待即可上传下一个宝贝</span>
              </div>
            </li>
          </ul>

          <center>
              <button class="publish-btn" style="margin-top:10px">发布</button><img class="loading" src="Public/Image/loading.gif"></img>
              <div>
                  <ul class="imgs-need-move">
                  </ul>
              </div>
          </center>

          <div style="height:30px"></div>
        </div>
      </div>
    </div>

  </form>
  <script>
  $(function () {
      /* init desc editor */
      $('#desc').cleditor({height:500});
      /* end */

      /* init 20000 prop input */
      $('select#prop_20000').parent().append('<input type="text" name="band"/>');
      /* end */

      /* default to select other dist picture */
      $('select#prop_20418023').val('20418023:157305309');
      /* end */

      /* add store */
      $('#add-store').on('click', function () {
          window.location = "{:U('Taobao/Index/auth')}" + '&taobaoItemId={$taobaoItemId}&newStore=newStore&taobaoAppKey=trival';
      });
      /* end */

      /* save user config */
      $('.saveAndEffect').on('click', function () {
          $.ajax({
              url: "{:U('Taobao/Upload/saveConfig')}",
              data: {
                  'nick': '{$nick}',
                  'percent': $('#percent').val(),
                  'profit': $('#profit').val(),
                  'postFee': $('#postFee').val(),
                  'expressFee': $('#expressFee').val(),
                  'emsFee': $('#emsFee').val(),
                  'buyerFreight': $('#buyerFreight').attr('checked') ? '1' : '0',
                  'usePostModu': $('#useModuFreight').attr('checked') && $('#buyerFreight').attr('checked') ? $('#templateId').val() : '999'
              },
              success: function (data) {
                  location.href = location.href;
              }
          });
      });
      /* end */

      var closeWindow = function () {
          window.opener = null;
          window.open('', '_self');
          window.close();
      };

      /* close window if the item is delisted */
      var isDelist = {$isDelist|default="false"};
      if (isDelist) {
          alert('抱歉，该宝贝已下架！');
          closeWindow();
      }
      /* end */

      /* let user confirm to uploading duplicated item */
      var isCurrentTaobaoItemIdInSession = {$isCurrentTaobaoItemIdInSession|default="false"};
      if (isCurrentTaobaoItemIdInSession) {
          if (confirm('亲，当前商品刚刚已经上传过了哟！确认继续上传吗？')) {
              window.location = 'http://' + window.location.host + "{:U('Taobao/Upload/editItem')}" + '&continue=true';
          } else {
              closeWindow();
          }
      }
      /* end */

      /* props which are parent */
      $('.props-ul select').on('change', function () {
          var value = $(this).val(),
              $option = $('option[value="'+value+'"]');
          if ($option.attr('parent') === 'true') {
              $(this).parent().children('select.child_prop').css('display', 'none').attr('disabled', 'disabled');
              $('select[parent="'+value+'"]').css('display', '').removeAttr('disabled');
          }
      });
      $('.props-ul select').change();
      /* end */

      /* count down title */
      $('#title').on('keydown', function (event) {
          var $title = $(this),
              length = getLength($title.val()),
              delta = 60 - length;
          if (delta >= 0) {
              $('.title-countdown').css('color', 'green');
              $('.title-countdown').text('还能输入' + delta + '字');
          } else {
              $('.title-countdown').css('color', 'red');
              $('.title-countdown').text('已经超过' + (delta * -1) + '字');
          }
      });

      var getLength = function (str) {
          var len = str.length;
          var reLen = 0;
          for (var i = 0; i < len; i++) {
              if (str.charCodeAt(i) < 27 || str.charCodeAt(i) > 126) {
                  // 全角
                  reLen += 2;
              } else {
                  reLen++;
              }
          }
          return reLen;
      };
      /* end */

      /* sku table */
      $('.sku-item').on('click', function (event) {
          event.stopPropagation();
          rebuildSkuTable();
      });

      $('.sku-list input[type=text]').on('change', function (event) {
          event.stopPropagation();
          rebuildSkuTable();
      });

      var countQuantity = function () {
          var num = 0;
          $('.quantity-input').each(function () {
              val = parseInt($(this).val());
              if (!isNaN(val)) {
                  num += val;
              }
          });
          $('#num').val(num);
      };

      var rebuildSkuTable = function () {
          var $colors = $('.sku-list.color input[type=checkbox]:checked').siblings('input');
          var $sizes = $('.sku-list.size input[type=checkbox]:checked').siblings('input');
          $('#sku-tbody').children().remove();
          $('#sku-tbody').append(makeSkuTableHtml($colors, $sizes));
          countQuantity();
      };

      var makeSkuTableHtml = function ($colors, $sizes) {
          var html = '';
          if ($sizes.length === 0) {
              $colors.each(function () {
                  var $color = $(this),
                      color = $(this).val();
                  html += '<tr class="J_MapRow">';
                  html += '<td class="color-td" data="'+$color.attr('id').substr(8)+'">'+color+'</td>';
                  html += '<td></td>';
                  html += '<td><input class="price-input" type="text" value="' + $('#price').val() + '"/></td>';
                  html += '<td><input class="quantity-input" type="text" value="999"/></td>';
                  html += '<td><input class="outer-id-input" type="text"/></td>';
                  html += '<td><input type="text"/></td>';
                  html += '</tr>';
              });
          } else {
              $colors.each(function () {
                  var $color = $(this),
                  color = $(this).val();
                  $sizes.each(function () {
                      var $size = $(this),
                          size = $(this).val();
                      html += '<tr class="J_MapRow">';
                      html += '<td class="color-td" data="'+$color.attr('id').substr(8)+'">'+color+'</td>';
                      html += '<td class="size-td" data="'+$size.attr('id').substr(8)+'">'+size+'</td>';
                      html += '<td><input class="price-input" type="text" value="' + $('#price').val() + '"/></td>';
                      html += '<td><input class="quantity-input" type="text" value="999"/></td>';
                      html += '<td><input class="outer-id-input" type="text"/></td>';
                      html += '<td><input type="text"/></td>';
                      html += '</tr>';
                  });
              });
          }
          return html;
      };
      /* end */

      /* init sku */
      var initSkus = {$initSkus|default="[]"};
      var propAlias = '{$propAlias}';
      var getPropAlias = function (propVid, propValue) {
          var position = propAlias.indexOf(propVid);
          if (position != -1) {
              var nextPosition = propAlias.indexOf(';', position),
              propString = propAlias.substring(position, nextPosition == -1 ? propAlias.length : nextPosition);
              return propString.split(':')[1];
          }
          return propValue;
      };
      var propNotFound = [];
      for (var i in initSkus) {
          var sku = initSkus[i];
          if (~sku.properties_name.indexOf(';')) { // from taobao
              var propertiesParts = sku.properties_name.split(';');
              for (var j in propertiesParts) {
                  var propertiesMoreParts = propertiesParts[j].split(':'),
                  prop = propertiesMoreParts[0] + ':' + propertiesMoreParts[1],
                  $checkbox = $('input[value="'+prop+'"]');
                  if ($checkbox.length === 0 && !~yaIndexOf(propNotFound, prop)) {
                      propNotFound.push(prop);
                      var $allCheckboxs = $('input[name=cp_'+propertiesMoreParts[0]+']');
                      var allCheckboxsCount = $allCheckboxs.length;
                      $checkbox = $allCheckboxs.eq(allCheckboxsCount - propNotFound.length);
                  }
                  if ($checkbox.length > 0) {
                      $checkbox.siblings('input[type=text]').val(getPropAlias(propertiesMoreParts[1], propertiesMoreParts[3]));
                      $checkbox.siblings('label:eq(1)').text(getPropAlias(propertiesMoreParts[1], propertiesMoreParts[3]));
                      if (typeof($checkbox.attr('checked')) === 'undefined') {
                          $checkbox.click();
                          rebuildSkuTable();
                      }
                  }
              }
          } else { // from ecmall database
              var propertiesParts = sku.properties_name.split(':');
              for (var j in propertiesParts) {
                  var $label = $('label[title=' + propertiesParts[j] + ']');
                  if ($label.length > 0) {
                      var $checkbox = $label.siblings('input[type=checkbox]');
                      if (typeof($checkbox.attr('checked')) === 'undefined') {
                          $checkbox.click();
                          rebuildSkuTable();
                      }
                  } else {
                      $checkbox = $('.sku-list:eq(' + j + ')').find('input[type=checkbox]:eq(' + i + ')');
                      $checkbox.siblings('input[type=text]').val(propertiesParts[j]);
                      $checkbox.siblings('label:eq(1)').text(propertiesParts[j]);
                      if (typeof($checkbox.attr('checked')) === 'undefined') {
                          $checkbox.click();
                          rebuildSkuTable();
                      }
                  }
              }
          }
      }
      /* end */

      /* price */
      $('#price').on('change', function () {
          rebuildSkuTable();
      });
      /* end */

      /* num */
      $('.quantity-input').live('change', function () {
          countQuantity();
      });
      /* end */

      /* pictures */
      $('.item-images img').on('click', function () {
          var $img = $(this),
              result = window.showModalDialog('picdemo1/propic.php',
                                              ['{$taobaoItemTitle}', $img.attr('src'), {$imgsInDesc}],
                                              'center:yes;resizable:no;dialogHeight:600px;dialogWidth:1080px');
          if (result == null) {
              alert("您没有更改主图!若点击下一页不出现图片，请等待图片下载完成后再次点击更改主图按钮");
          } else {
              $img.attr('src', result[2].toString());
              $img.siblings('input').val(result[2].toString());
          }
      });
      /* end */

      /* list time */
      var rebuildHourOptions = function () {
          var dateObj = new Date(),
              minHour = 0,
              buffer = '';
          if ($('#__date').val() === dateObj.getFullYear() + '-'
              + makeSureDoubleDigits(dateObj.getMonth() + 1) + '-'
              + makeSureDoubleDigits(dateObj.getDate())) {
              minHour = dateObj.getHours() + 1;
          }
          for (var i = minHour; i < 24; i++) {
              buffer += '<option value="' + makeSureDoubleDigits(i) + '">'
                  + i + '</option>';
          }
          $('#__hour').children().remove();
          $('#__hour').append(buffer);
      };

      $('#__date').on('change', function () {
          rebuildHourOptions();
      });

      var makeSureDoubleDigits = function (number) {
          if (number < 10) {
              number = '0' + number;
          }
          return number;
      };

      var makeDateOptions = function () {
          var options = '',
          dateObj = new Date();
          for (var i = 0; i < 14; i++) {
              var year = dateObj.getFullYear(),
              month = makeSureDoubleDigits(dateObj.getMonth() + 1),
              date = makeSureDoubleDigits(dateObj.getDate());
              options += '<option value="' + year + '-' + month + '-' + date + '">'
              options += year + '年' + month + '月' + date + '日';
              options += '</option>';
              dateObj.setDate(dateObj.getDate() + 1);
          }
          return options;
      };

      $('#__date').append(makeDateOptions());
      rebuildHourOptions();
      /* end */

      /* submit */
      var pcid = '{$pcid}';
      var imgsInDesc = $.parseJSON('{$imgsInDesc}');
      var imgsInDescCount = imgsInDesc.length;
      var newDesc = '';

      var checkTitle = function (title) {
          if (getLength(title) > 30) {
              return title.substr(0, 30);
          }
          return title;
      };

      var submitForm = function() {
          $('.publish-btn').text('正在发布中，请稍候...');
          $('#J_SKUTableData').val(getSkuTableData());
          $('#desc-hidden').val($('#desc').val());
          $('#price-hidden').val($('#price').val());
          $('#title-hidden').val(checkTitle($('#title').val()));
          $('#location-state-hidden').val($('#location-state').val());
          $('#location-city-hidden').val($('#location-city').val());
          $('#outer-id-hidden').val($('#outer-id').val());
          setTimeout(function () {
              $('#mainform').submit()
          }, 0);
      };

      var itemImages = {};
      var itemImagesTotalCount = 0;
      var itemImagesCount = 0;

      var isAllRequestComplete = function() {
          if ($('input[name=movePic]').attr('checked') === 'checked') {
              return $('.move-success').length === 2 * imgsInDescCount && itemImagesCount === itemImagesTotalCount;
          } else {
              return itemImagesCount === itemImagesTotalCount;
          }
      };

      var postAllRequest = function() {
          var jsonStr = '[';
          for(var i = 1; i <= 5; i++) {
              jsonStr += '"' + itemImages['picUrl'+i] + '",';
          }
          jsonStr = jsonStr.substr(0, jsonStr.length - 1) + ']';
          $('#itemImages').val(jsonStr);
          $('#desc').val(newDesc);
          submitForm();
      };

      var uploadPicture = doRequest({
          url: "{:U('Taobao/Upload/downloadPicture')}",
          makeData: function(imgUrl) {
              return {
                  'imgUrl': imgUrl
              };
          },
          success: function(data, tasks) {
              var imgUrl = data['imgUrl'];
              var imgPath = data['imgPath'];
              itemImages[$('input[value="'+imgUrl+'"]').attr('name')] = imgPath;
              itemImagesCount += 1;
              if (isAllRequestComplete()) {
                  postAllRequest();
              } else {
                  batchUploadPicture(tasks);
              }
          },
          retry: function(imgUrl, tasks) {
              retryUploadPicture(imgUrl, tasks);
          }
      });

      var batchUploadPicture = doInBatch(uploadPicture);

      var retryUploadPicture = doRetry(function(imgUrl) {
          itemImages[$('input[value="'+imgUrl+'"]').attr('name')] = '';
          itemImagesCount += 1;
          if (isAllRequestComplete()) {
              postAllRequest();
          }
      }, batchUploadPicture);

      var uploadDescPicture = doRequest({
          url: "{:U('Taobao/Upload/uploadTaobaoPicture')}",
          makeData: function(imgUrl) {
              return {
                  'imgUrl': imgUrl,
                  'pictureCategoryId': pcid
              };
          },
          success: function(data, tasks) {
              var $li = $('li[old-url="'+data['oldImgUrl']+'"]');
              $li.children('.uploading').remove();
              newDesc = newDesc.replace(new RegExp(data['oldImgUrl'], 'g'), data['newImgUrl']);
              $li.append('<span class="move-success" style="color:lightgreen">&nbsp;搬家成功</span>');
              if (isAllRequestComplete()) {
                  postAllRequest();
              } else {
                  batchUploadDescPicture(tasks);
              }
          },
          retry: function(imgUrl, tasks) {
              retryUploadDescPicture(imgUrl, tasks);
          }
      });

      var batchUploadDescPicture = doInBatch(uploadDescPicture);

      var retryUploadDescPicture = doRetry(function(imgUrl) {
          var $li = $('li[old-url="'+imgUrl+'"]');
          $li.children('.uploading').remove();
          newDesc = newDesc.replace(new RegExp(imgUrl, 'g'), '');
          $li.append('<span class="move-success" style="color:red">&nbsp;多次尝试搬家失败，已忽略</span>');
          if (isAllRequestComplete()) {
              postAllRequest();
          }
      }, batchUploadDescPicture);

      $('.publish-btn').on('click', function (event) {
          event.preventDefault();
          var $btn = $(this);
          var btnText = $btn.text();
          if (btnText === '侦测到详情图片需要搬家，搬家中，请稍候...' || btnText === '正在发布中，请稍候...') {
              return false;
          }
          newDesc = $('#desc').val();
          // 上传主图
          var picUrls = [];
          $('.picUrl').each(function() {
              var url = $(this).val();
              if (url) {
                  picUrls.push(url);
              }
          });
          itemImagesTotalCount = picUrls.length;
          batchUploadPicture(picUrls);
          if ($('input[name=movePic]').attr('checked') === 'checked') {
              if (pcid) {
                  if (imgsInDesc.length > 0) {
                      $('.publish-btn').text('侦测到详情图片需要搬家，搬家中，请稍候...');
                      $('.loading').css('display', 'inline');
                      // 去重
                      var imgs = [];
                      for(var i = 0; i < imgsInDesc.length; i++) {
                          var imgUrl = imgsInDesc[i];
                          if (!~yaIndexOf(imgs, imgUrl) && imgUrl.indexOf('.webp') !== imgUrl.length - 5 && ~imgUrl.indexOf('!!')) {
                              imgs.push(imgUrl);
                          }
                      }
                      imgsInDesc = imgs;
                      imgsInDescCount = imgsInDesc.length;
                      var appendString = '';
                      for(var j = 0; j < imgsInDesc.length; j++) {
                          var img = imgsInDesc[j];
                          appendString += '<li old-url="'+img+'">'+img+'<span class="uploading">&nbsp;上传中</span></li>';
                      }
                      $('.imgs-need-move').append(appendString);
                      // 如果用户点击了页面下方的发布按钮, 则滚动到页面底部显示搬家状态
                      if ($(this).offset().top > 1000) {
                          window.scroll(0, 999999);
                      }
                      batchUploadDescPicture(imgsInDesc);
                  }
              } else {
                  alert('图片搬家获取相册信息失败，请刷新页面重试，或者取消勾选图片搬家');
                  return false;
              }
          }
      });

      var getSkuTableData = function () {
          var data = '{';
          $('.J_MapRow').each(function () {
              var $tr = $(this);
              data += '"' +
                  $tr.find('.color-td').attr('data') +
                  ($tr.find('.size-td').length > 0 ? '_' + $tr.find('.size-td').attr('data') : '') +
                  '":{' +
                  '"price":"' + $tr.find('.price-input').val() + '",' +
                  '"quantity":"' + $tr.find('.quantity-input').val() + '",' +
                  '"outer_id":"' + $tr.find('.outer-id-input').val() + '"' +
                  '},';
          });
          if (data.length > 1) {
              data = data.substr(0, data.length - 1);
          }
          data += '}';
          return data;
      }
      /* end */

      /* city */
      $('#location-state').on('change', function () {
          setCity();
      });
      /* end */

      /* 吊牌价必填,但是其值不知道从哪里拿,所以先写死 */
      var $brandPrice = $('#prop_6103476');
      if ($brandPrice.length > 0) {
          $brandPrice.val(500);
      }
      /* end */
  });
  </script>
</body>
</html>
